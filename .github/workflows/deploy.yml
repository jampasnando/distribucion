name: üöÄ Deploy Distribucion src to Hestia

# Se ejecuta cuando hay push a main
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Clonar el repositorio en Actions
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Cargar la clave SSH para conectarse al servidor
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      # 3Ô∏è‚É£ Conectar al servidor y desplegar solo src/
      - name: Deploy src to Hestia server
        run: |
          ssh -o StrictHostKeyChecking=no jampasnandox@152.67.44.214 "
            # Rutas
            TMP_DIR=/tmp/distribucion_deploy
            PUBLIC_HTML=/home/jampasnandox/web/distribucion.elofertononline.com.bo/public_html

            # Limpiar carpeta temporal
            rm -rf \$TMP_DIR

            # Clonar todo el repo temporalmente
            git clone https://github.com/jampasnando/distribucion.git \$TMP_DIR

            # Copiar solo src/ a public_html, EXCLUYENDO .env y storage
            rsync -av --delete \
              --exclude='.env' \
              --exclude='storage/' \
              --exclude='vendor/' \
              \$TMP_DIR/src/ \$PUBLIC_HTML/

            # Entrar a public_html
            cd \$PUBLIC_HTML

            # Instalar dependencias de PHP
            composer install --no-dev --optimize-autoloader

            # Ejecutar migraciones si es necesario (opcional, descomenta si conf√≠as)
            # php artisan migrate --force

            # Limpiar y cachear configuraci√≥n y rutas
            php artisan config:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:clear
            php artisan view:cache

            php artisan storage:link || true
            
            # Permisos correctos
            chmod -R 775 storage bootstrap/cache
          "
